<%- include('../layouts/userHeader.ejs') %>


<script>
    paceOptions = {
      elements: true
    };
  </script>

    <!--/.row-->
    <div class="container main-container headerOffset">
        <div class="row">
            <div class="breadcrumbDiv col-lg-12">
                <ul class="breadcrumb">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="cart.html">Cart</a></li>
                    <li class="active">Checkout</li>
                </ul>
            </div>
        </div>
        <!--/.row-->
    
        <div class="row">
            <div class="col-lg-9 col-md-9 col-sm-7">
                <h1 class="section-title-inner"><span><i class="glyphicon glyphicon-shopping-cart"></i> ONEPAGE CHECKOUT</span></h1>
            </div>
            <div class="col-lg-3 col-md-3 col-sm-5 rightSidebar">
                <h4 class="caps"><a href="category.html"><i class="fa fa-chevron-left"></i> Back to shopping </a></h4>
            </div>
        </div>
        <!--/.row-->
    
        <div class="row">
            <div class="col-lg-9 col-md-9 col-sm-12">
                <div class="row userInfo">
                    <div class="col-xs-12 col-sm-12">
                        <div class="w100 clearfix">
                            <div class="row userInfo">
                                <div style="clear: both"></div>
                                <div class="onepage-checkout col-lg-12">
                                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                        <div class="panel panel-default">
                                            <div class="panel-heading" role="tab" id="headingOne">
                                                <h4 class="panel-title">
                                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#BillingInformation"
                                                        aria-expanded="true" aria-controls="BillingInformation">
                                                        Billing and Shipping information
                                                    </a>
                                                </h4>
                                            </div>
                                            <div id="BillingInformation" class="panel-collapse collapse in" role="tabpanel"
                                                aria-labelledby="BillingInformation">
                                                <div class="panel-body">
                                                    <div style="clear: both"></div>
                                                    <div id="exisitingAddressBox" class="collapse in">
                                                        <div class="form-group uppercase"><strong>Select address</strong></div>
                                                        <div class="w100 clearfix">
                                                            <% addressData.forEach(function(address) { %>
                                                                <div class="col-xs-12 col-sm-6 col-md-4">
                                                                    <div class="panel panel-default">
                                                                        <div class="panel-heading">
                                                                            <h3 class="panel-title"><strong><%= address.addressTitle %></strong></h3>
                                                                        </div>
                                                                        <div class="panel-body">
                                                                            <ul>
                                                                                <li><span class="address-name"> <strong><%= address.firstName %> <%= address.lastName %></strong></span></li>
                                                                                <li><span class="address-line1"><%= address.addressLine1 %></span></li>
                                                                                <li><span class="address-line2"><%= address.addressLine2 %></span></li>
                                                                                <li><span> <strong>Mobile</strong> : <%= address.phone %></span></li>
                                                                            </ul>
                                                                        </div>
                                                                        <div class="panel-footer panel-footer-address">
                                                                            <a href="/account/editAddress/<%= address._id %>" class="btn btn-sm btn-success"> <i class="fa fa-edit"></i> Edit </a>
                                                                            <a class="btn btn-sm btn-danger" onclick="return confirm('Do you want to delete?')" href="/account/deleteAddress/<%= address._id %>"> <i class="fa fa-minus-circle"></i> Delete </a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            <% }); %>
                                                        </div>
                                                        <!--/.w100-->
                                                        <div class="gap"></div>
                                                        <div class="col-lg-12 clearfix">
                                                            <a class="btn btn-primary" href="/account/addAddress"><i class="fa fa-plus-circle"></i> Add New Address </a>
                                                        </div>
                                                        <div class="gap"></div>
                                                        <div class="form-group required maxwidth300">
                                                            <label for="InputCountry">Select Address <sup>*</sup></label>
                                                            <select class="form-control" required aria-required="true" id="SelectAddress" name="chosenAddress">
                                                                <% addressData.forEach(function(address) { %>
                                                                    <option value="<%= address._id %>"> <%= address.addressTitle %></option>
                                                                <% }); %>
                                                            </select>
                                                            <br>
                                                        </div>
                                                    </div>
                                                    <div class="panel panel-default">
                                                        <div class="panel-heading" role="tab" id="">
                                                            <h4 class="panel-title">
                                                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                                                                    href="#Paymentmethod" aria-expanded="false" aria-controls="Paymentmethod">
                                                                    Payment method
                                                                </a>
                                                            </h4>
                                                        </div>
                                                        <div id="Paymentmethod" class="panel-collapse collapse" role="tabpanel">
                                                            <div class="panel-body">
                                                                <div class="onepage-payment">
                                                                    <div style="clear:both;"></div>
                                                                    <div class="card-paynemt-box payment-method">
                                                                        <label class="radio-inline" for="CashOnDelivery" aria-controls="CashOnDeliveryCollapse">
                                                                            <input name="radios" id="COD" value="COD" type="radio" checked>Cash On Delivery
                                                                        </label>
                                                                    </div>
                                                                    <div class="card-paynemt-box payment-method">
                                                                        <label class="radio-inline" for="wallet" aria-controls="CashOnDeliveryCollapse">
                                                                            <input name="radios" id="wallet" value="wallet" type="radio">Wallet
                                                                        </label>
                                                                    </div>
                                                                    <div class="card-paynemt-box payment-method">
                                                                        <label class="radio-inline" for="razorpay" aria-controls="CashOnDeliveryCollapse">
                                                                            <input name="radios" id="razorpay" value="razorpay" type="radio">Razorpay
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div id="orderBtn" class="pull-left btn btn-primary btn-lg">
                                                        Order &nbsp; <i class="fa fa-arrow-circle-right"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--/row end-->
                        </div>
                    </div>
                    <!--/row end-->
                </div>
            </div>
            <div class="col-lg-3 col-md-3 col-sm-12 rightSidebar">
                <div class="w100 cartMiniTable">
                    <table id="cart-summary" class="std table">
                        <tbody>
                            <tr>
                                <td>Total Price</td>
                                <td class="price" id="totalPrice1">₹<%= grandTotal %></td>
                            </tr>
                            <tr>
                                <td>Shipping</td>
                                <td class="price">Free shipping!</td>
                            </tr>
                            <tr>
                                <td>Total Discount</td>
                                <td class="price" id="totalDiscount">₹0</td>
                            </tr>
                            <tr>
                                <td>Grand Total</td>
                                <td class="site-color" id="total-price">₹<span id="grandTotal"><%= grandTotal %></span></td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="input-append couponForm">
                                        <form id="couponApplyForm">
                                            <input class="col-lg-8" name="couponCode" id="appendedInputButton" type="text" placeholder="Enter coupon code">
                                            <button class="col-lg-4 btn btn-success" type="submit">Apply!</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!--  /cartMiniTable-->
            </div>
            <!--/rightSidebar-->
        </div>
        <!--/row-->
        <div style="clear:both"></div>
    </div>

    <!-- Placed at the end of the document so the pages load faster -->
  <script src="assets/js/jquery/jquery-2.1.3.min.js"></script>


  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <!-- include  parallax plugin -->
  <script type="text/javascript" src="assets/js/jquery.parallax-1.1.js"></script>

  <!-- optionally include helper plugins -->
  <script type="text/javascript" src="assets/js/helper-plugins/jquery.mousewheel.min.js"></script>

  <!-- include mCustomScrollbar plugin //Custom Scrollbar  -->

  <script type="text/javascript" src="assets/js/jquery.mCustomScrollbar.js"></script>

  <!-- include icheck plugin // customized checkboxes and radio buttons   -->
  <script type="text/javascript" src="assets/plugins/icheck-1.x/icheck.min.js"></script>

  <!-- include grid.js // for equal Div height  -->
  <script src="assets/plugins/jquery-match-height-master/dist/jquery.matchHeight-min.js"></script>
  <script src="assets/js/grids.js"></script>

  <!-- include carousel slider plugin  -->
  <script src="assets/js/owl.carousel.min.js"></script>

  <!-- jQuery select2 // custom select   -->
  <script src="../../../../cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>

  <!-- include touchspin.js // touch friendly input spinner component   -->
  <script src="assets/js/bootstrap.touchspin.js"></script>

  <!-- include custom script for site  -->
  <script src="assets/js/script.js"></script>
    
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<script>
    const orderBtnElement = document.getElementById('orderBtn')
    const CODElement = document.getElementById('COD')
    const razorpayElement = document.getElementById('razorpay')
    const walletElement = document.getElementById('wallet')

    orderBtnElement.addEventListener('click', orderBtnClickFunction)

    async function orderBtnClickFunction(event) {
      try {
        console.log('1');
        event.preventDefault()
        console.log('1');

        if (CODElement.checked) {//cash on delivery 
          window.location.href = '/checkout/orderPlacedEnd'
        } else if (walletElement.checked) {
          let response = await fetch("/checkout/orderPlaced", {
            method: "POST", // or 'PUT'
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ walletPayment: true }),
          });
          response = await response.json()
          if (response.insufficientWalletBalance) {
            return Swal.fire({
              icon: "error",
              title: "Insufficient Balance",
              text: "No sufficent balance"
            });
          } else if (response.success) {
            window.location.href = '/checkout/orderPlacedEnd'
          }
        }else if (razorpayElement.checked) {
            console.log('razz');

          const orderResponse = await fetch('/checkout/razorpay/create/orderId', { method: 'POST' })
          const order = await orderResponse.json()
          console.log(order)
          await openRazorpay(order.amount, order.id)
        }
      } catch (error) {
        console.error(error)
      }

    }

    async function openRazorpay(amount, orderId) {
      try {
        var options = {
          "key": 'rzp_test_LSVsVjKJgjMK1G', // Enter the Key ID generated from the Dashboard
          "amount": '' + amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
          "currency": "INR",
          "name": "SMART STORE",
          "description": "Test Transaction",
          "callback_url": "/checkout/orderPlaced",
          "image": "/images/logo-dark.png",
          "order_id": orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
          "theme": {
            "color": "#3399cc"
          }
        };
        var razorpay = new Razorpay(options);
        razorpay.open()
      } catch (error) {
        console.error(error)
      }

    }

  </script>





<script>
  // Attach a submit event listener to the couponApplyForm element
  document.addEventListener('DOMContentLoaded', function () {
    const couponApplyFormElement = document.getElementById('couponApplyForm');
    couponApplyFormElement.addEventListener('submit', async function (e) {
      e.preventDefault();
      await couponApply();
    });
  });

  // Async function to handle coupon application
  async function couponApply() {
    try {
      // Prepare form data with the coupon code
      const couponApplyForm = document.getElementById('couponApplyForm');
      const formData = { couponCode: couponApplyForm.couponCode.value };

      // Send a POST request to the server to apply the coupon
      const response = await fetch('/checkout/applyCoupon', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      // Parse the JSON response from the server
      const { couponApplied, discountAmount } = await response.json();

      // Check if the coupon is applied or not
      if (couponApplied) {
        // If the coupon is applied, update the UI and show a success message
        const grandTotalElement = document.getElementById('grandTotal');
        const grandTotal = parseFloat(grandTotalElement.innerHTML.replace('₹', '')) - discountAmount;
        grandTotalElement.innerHTML = '₹' + grandTotal.toFixed(2);

        const totalDiscountElement = document.getElementById('totalDiscount');
        totalDiscountElement.innerHTML = '₹' + discountAmount.toFixed(2);

        await Swal.fire({
          icon: "success",
          title: "Coupon has been applied",
          showConfirmButton: false,
          timer: 1500,
        });
      } else {
        // If the coupon is not applicable, show an error message
        await Swal.fire({
          icon: "error",
          title: "Coupon not applicable",
          text: "Sorry! Your coupon is not applicable",
        });
      }
    } catch (error) {
      console.error('Error applying coupon:', error);
      // Handle error if necessary
    }
  }
</script>




  


<%- include('../layouts/userFooter.ejs') %>
